<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Identity Demo</title>
  <style>
    :root {
      --bg-0: #0d1117; --bg-1: #161b22; --bg-2: #21262d; --bg-3: #30363d;
      --border: #30363d; --text-0: #e6edf3; --text-1: #8b949e; --text-2: #6e7681;
      --blue: #58a6ff; --green: #3fb950; --red: #f85149;
      --yellow: #d29922; --purple: #bc8cff; --orange: #f0883e;
      --font-mono: 'JetBrains Mono','Fira Code','Cascadia Code','Consolas',monospace;
      --font-sans: -apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;
      --radius: 8px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:var(--font-sans); background:var(--bg-0); color:var(--text-0);
           height:100vh; display:flex; flex-direction:column; overflow:hidden; }

    /* ── Header ─────────────────────────────────────────── */
    header { background:var(--bg-1); border-bottom:1px solid var(--border);
             padding:0.75rem 1.5rem; display:flex; align-items:center;
             justify-content:space-between; flex-shrink:0; }
    .brand { font-family:var(--font-mono); font-size:1rem; font-weight:700; color:var(--blue); }
    .header-controls { display:flex; align-items:center; gap:1rem; }
    .mode-toggle { display:flex; background:var(--bg-2); border-radius:6px;
                   border:1px solid var(--border); overflow:hidden; }
    .mode-btn { padding:0.4rem 1rem; border:none; background:transparent; color:var(--text-1);
                font-family:var(--font-sans); font-size:0.85rem; font-weight:600;
                cursor:pointer; transition:all 0.2s; }
    .mode-btn.active { background:var(--blue); color:#fff; }
    .mode-btn:hover:not(.active) { color:var(--text-0); }
    .persona-badge { font-size:0.8rem; padding:0.3rem 0.75rem; border-radius:12px; font-weight:600; }
    .persona-badge { background:var(--bg-2); color:var(--text-1); border:1px solid var(--border); }
    .persona-badge.alice { background:rgba(88,166,255,0.15); color:var(--blue);
                           border:1px solid rgba(88,166,255,0.3); }
    .persona-badge.attacker { background:rgba(248,81,73,0.15); color:var(--red);
                              border:1px solid rgba(248,81,73,0.3); }
    .reset-btn, .endpoints-btn { padding:0.4rem 0.75rem; background:var(--bg-2);
                 border:1px solid var(--border); color:var(--text-1); border-radius:6px;
                 font-size:0.8rem; cursor:pointer; font-family:var(--font-sans); position:relative; }
    .reset-btn:hover, .endpoints-btn:hover { border-color:var(--text-1); color:var(--text-0); }
    .endpoints-dropdown { display:none; position:absolute; top:100%; right:0; margin-top:0.4rem;
                          background:var(--bg-1); border:1px solid var(--border); border-radius:6px;
                          min-width:280px; z-index:50; box-shadow:0 8px 24px rgba(0,0,0,0.4);
                          padding:0.5rem 0; }
    .endpoints-dropdown.open { display:block; }
    .endpoints-dropdown-header { padding:0.3rem 0.75rem; font-size:0.65rem; color:var(--text-2);
                                  text-transform:uppercase; letter-spacing:0.05em; }
    .endpoints-dropdown a { display:block; padding:0.35rem 0.75rem; color:var(--text-0);
                            text-decoration:none; font-size:0.8rem; font-family:var(--font-mono); }
    .endpoints-dropdown a:hover { background:var(--bg-2); }
    .endpoints-dropdown a .ep-port { color:var(--text-2); font-size:0.7rem; }

    /* ── Main layout ────────────────────────────────────── */
    main { flex:1; display:grid; grid-template-columns:1fr 380px; overflow:hidden; }

    /* ── Chat panel ─────────────────────────────────────── */
    .chat-panel { display:flex; flex-direction:column; border-right:1px solid var(--border); overflow:hidden; }
    .chat-messages { flex:1; overflow-y:auto; padding:1rem 1.5rem;
                     display:flex; flex-direction:column; gap:0.75rem; }
    .msg { max-width:85%; padding:0.6rem 1rem; border-radius:var(--radius);
           line-height:1.6; font-size:0.95rem; animation:fadeIn 0.2s ease-out; }
    .msg-user { align-self:flex-end; background:var(--blue); color:#fff;
                border-bottom-right-radius:2px; }
    .msg-assistant { align-self:flex-start; background:var(--bg-2);
                     border-bottom-left-radius:2px; }
    .msg-assistant strong { color:var(--blue); }
    .msg-assistant code { background:var(--bg-0); padding:0.1em 0.3em; border-radius:3px;
                          font-family:var(--font-mono); font-size:0.85em; }
    .msg-system { align-self:center; color:var(--text-1); font-size:0.85rem;
                  font-style:italic; padding:0.4rem 0; }

    /* ── Tool call blocks ───────────────────────────────── */
    .tool-call { align-self:flex-start; width:92%; background:var(--bg-1);
                 border:1px solid var(--border); border-radius:var(--radius);
                 font-family:var(--font-mono); font-size:0.8rem;
                 animation:fadeIn 0.2s ease-out; }
    .tool-call-header { display:flex; align-items:center; gap:0.5rem;
                        padding:0.5rem 0.75rem; cursor:pointer; user-select:none; }
    .tool-call-header:hover { background:var(--bg-2); }
    .tc-status { width:18px; text-align:center; flex-shrink:0; }
    .tc-status.pending { color:var(--yellow); animation:pulse 1s infinite; }
    .tc-status.success { color:var(--green); }
    .tc-status.error { color:var(--red); }
    .tc-name { font-weight:600; color:var(--purple); }
    .tc-summary { color:var(--text-2); font-size:0.75rem; margin-left:0.5rem;
                  overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .tc-status.error + .tc-name ~ .tc-summary { color:var(--red); }
    .tc-chevron { margin-left:auto; color:var(--text-2); transition:transform 0.2s; flex-shrink:0; }
    .tc-chevron.open { transform:rotate(90deg); }
    .tc-body { border-top:1px solid var(--border); padding:0.5rem 0.75rem; display:none; }
    .tc-body.open { display:block; }
    .tc-label { color:var(--text-2); font-size:0.7rem; text-transform:uppercase;
                letter-spacing:0.05em; margin-bottom:0.25rem; }
    .tc-json { background:var(--bg-0); padding:0.5rem; border-radius:4px; overflow-x:auto;
               white-space:pre-wrap; word-break:break-all; color:var(--text-1);
               margin-bottom:0.5rem; max-height:180px; overflow-y:auto; }

    /* ── Suggested prompts ──────────────────────────────── */
    .suggested-prompts { display:flex; gap:0.5rem; padding:0.5rem 1.5rem;
                         flex-wrap:wrap; border-top:1px solid var(--border); min-height:0; }
    .prompt-chip { padding:0.35rem 0.75rem; background:var(--bg-2); border:1px solid var(--border);
                   border-radius:16px; color:var(--text-0); font-size:0.8rem; cursor:pointer;
                   transition:all 0.15s; white-space:nowrap; font-family:var(--font-sans); }
    .prompt-chip:hover { border-color:var(--blue); color:var(--blue); }

    /* ── Chat input ─────────────────────────────────────── */
    .chat-input-area { display:flex; gap:0.5rem; padding:0.75rem 1.5rem;
                       border-top:1px solid var(--border); background:var(--bg-1); }
    #chatInput { flex:1; background:var(--bg-2); border:1px solid var(--border); color:var(--text-0);
                 padding:0.6rem 1rem; border-radius:6px; font-family:var(--font-sans);
                 font-size:0.95rem; outline:none; }
    #chatInput:focus { border-color:var(--blue); }
    #chatInput:disabled { opacity:0.5; }
    #sendBtn { padding:0.6rem 1.5rem; background:var(--blue); color:#fff; border:none;
               border-radius:6px; font-family:var(--font-sans); font-weight:600;
               font-size:0.95rem; cursor:pointer; }
    #sendBtn:hover { opacity:0.9; }
    #sendBtn:disabled { opacity:0.4; cursor:not-allowed; }

    /* ── Artifact panel ─────────────────────────────────── */
    .artifact-panel { display:flex; flex-direction:column; overflow-y:auto; background:var(--bg-1); }
    .artifact-section { border-bottom:1px solid var(--border); padding:1rem; }
    .artifact-section h3 { font-size:0.8rem; color:var(--text-1); text-transform:uppercase;
                           letter-spacing:0.05em; margin-bottom:0.75rem;
                           display:flex; align-items:center; justify-content:space-between; }
    .artifact-empty { color:var(--text-2); font-size:0.85rem; font-style:italic; }
    .jwt-raw { font-family:var(--font-mono); font-size:0.7rem; background:var(--bg-0);
               padding:0.5rem; border-radius:4px; word-break:break-all; color:var(--orange);
               max-height:80px; overflow-y:auto; margin-bottom:0.5rem; cursor:pointer; }
    .jwt-decoded { font-family:var(--font-mono); font-size:0.7rem; background:var(--bg-0);
                   padding:0.5rem; border-radius:4px; white-space:pre-wrap; color:var(--text-1);
                   max-height:180px; overflow-y:auto; }
    .copy-btn { font-size:0.65rem; padding:0.15rem 0.5rem; background:var(--bg-2);
                border:1px solid var(--border); color:var(--text-1); border-radius:4px;
                cursor:pointer; font-family:var(--font-sans); }
    .copy-btn:hover { border-color:var(--text-1); color:var(--text-0); }
    .artifact-json { font-family:var(--font-mono); font-size:0.7rem; background:var(--bg-0);
                     padding:0.5rem; border-radius:4px; white-space:pre-wrap; color:var(--text-1);
                     max-height:220px; overflow-y:auto; }
    .mode-label { font-size:0.7rem; padding:0.15rem 0.5rem; border-radius:10px;
                  font-weight:600; display:inline-block; margin-bottom:0.5rem; }
    .mode-label.reusable { background:rgba(248,81,73,0.15); color:var(--red); }
    .mode-label.single-use { background:rgba(63,185,80,0.15); color:var(--green); }

    /* ── Modals ─────────────────────────────────────────── */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7);
                     display:none; justify-content:center; align-items:center; z-index:100; }
    .modal-overlay.visible { display:flex; }
    .modal { background:var(--bg-1); border:1px solid var(--border); border-radius:12px;
             padding:2rem; max-width:420px; width:90%; }
    .modal h2 { font-size:1.25rem; margin-bottom:1.5rem; }
    .form-group { margin-bottom:1rem; }
    .form-group label { display:block; font-size:0.85rem; color:var(--text-1); margin-bottom:0.3rem; }
    .form-group input { width:100%; padding:0.6rem 0.75rem; background:var(--bg-2);
                        border:1px solid var(--border); border-radius:6px; color:var(--text-0);
                        font-family:var(--font-sans); font-size:0.95rem; }
    .modal-btn { width:100%; padding:0.75rem; border:none; border-radius:6px;
                 font-family:var(--font-sans); font-size:1rem; font-weight:600;
                 cursor:pointer; margin-top:0.5rem; }
    .modal-btn.primary { background:var(--blue); color:#fff; }
    .modal-btn.success { background:var(--green); color:#fff; }
    .modal-note { font-size:0.8rem; color:var(--text-2); text-align:center; margin-top:1rem; }
    .wallet-modal h2 { color:var(--green); }
    .wallet-details { background:var(--bg-0); border-radius:6px; padding:1rem; margin-bottom:1.5rem; }
    .wallet-detail { display:flex; justify-content:space-between; padding:0.4rem 0;
                     border-bottom:1px solid var(--border); font-size:0.85rem; }
    .wallet-detail:last-child { border-bottom:none; }
    .wallet-detail-label { color:var(--text-1); flex-shrink:0; margin-right:1rem; }
    .wallet-detail-value { color:var(--text-0); font-weight:600; text-align:right; }

    /* ── Attacker theme ─────────────────────────────────── */
    body.attacker-mode header { border-bottom-color:var(--red); }
    body.attacker-mode .brand { color:var(--red); }
    body.attacker-mode .mode-toggle { display:none; }
    body.attacker-mode .msg-user { background:var(--red); }

    /* ── Animations ─────────────────────────────────────── */
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
  </style>
</head>
<body>
  <header>
    <div class="brand">LLM Identity Demo</div>
    <div class="header-controls">
      <div class="mode-toggle" id="modeToggle">
        <button class="mode-btn active" data-mode="jwt-only" onclick="switchMode('jwt-only')">JWT Only</button>
        <button class="mode-btn" data-mode="vc-protected" onclick="switchMode('vc-protected')">VC Protected</button>
      </div>
      <span class="persona-badge" id="personaBadge">Login</span>
      <button class="reset-btn" onclick="resetDemo()">Reset</button>
      <div style="position:relative;display:inline-block;">
        <button class="endpoints-btn" onclick="toggleEndpoints(event)">Endpoints</button>
        <div class="endpoints-dropdown" id="endpointsDropdown">
          <div class="endpoints-dropdown-header">VC Issuer</div>
          <a href="http://localhost:3001/issuer/info" target="_blank">/issuer/info <span class="ep-port">:3001</span></a>
          <a href="http://localhost:3001/.well-known/did.json" target="_blank">/.well-known/did.json <span class="ep-port">:3001</span></a>
          <div class="endpoints-dropdown-header">VC Wallet</div>
          <a href="http://localhost:3002/wallet/did" target="_blank">/wallet/did <span class="ep-port">:3002</span></a>
          <a href="http://localhost:3002/wallet/credentials" target="_blank">/wallet/credentials <span class="ep-port">:3002</span></a>
          <a href="http://localhost:3002/wallet/demo/state" target="_blank">/wallet/demo/state <span class="ep-port">:3002</span></a>
          <div class="endpoints-dropdown-header">Auth Server</div>
          <a href="http://localhost:3003/auth/jwks" target="_blank">/auth/jwks <span class="ep-port">:3003</span></a>
          <a href="http://localhost:3003/auth/trusted-issuers" target="_blank">/auth/trusted-issuers <span class="ep-port">:3003</span></a>
          <a href="http://localhost:3003/demo/audit-log" target="_blank">/demo/audit-log <span class="ep-port">:3003</span></a>
          <div class="endpoints-dropdown-header">Expense API</div>
          <a href="http://localhost:3005/demo/expenses" target="_blank">/demo/expenses <span class="ep-port">:3005</span></a>
          <a href="http://localhost:3005/demo/audit-log" target="_blank">/demo/audit-log <span class="ep-port">:3005</span></a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="chat-panel">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="suggested-prompts" id="suggestedPrompts"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Type a message..." disabled>
        <button id="sendBtn" disabled onclick="sendMessage()">Send</button>
      </div>
    </section>

    <aside class="artifact-panel" id="artifactPanel">
      <div class="artifact-section" id="jwtSection">
        <h3>JWT Token <button class="copy-btn" onclick="copyJwt()">Copy</button></h3>
        <div id="jwtContent"><span class="artifact-empty">No token yet</span></div>
      </div>
      <div class="artifact-section" id="vpSection">
        <h3>Verifiable Presentation</h3>
        <div id="vpContent"><span class="artifact-empty">No presentation yet</span></div>
      </div>
      <div class="artifact-section" id="vcSection">
        <h3>Credential Info</h3>
        <div id="vcContent"><span class="artifact-empty">No credentials loaded</span></div>
      </div>
    </aside>
  </main>

  <!-- Login Modal -->
  <div class="modal-overlay" id="loginModal">
    <div class="modal">
      <h2>Sign In to Acme Corp</h2>
      <div class="form-group">
        <label>Email</label>
        <input type="text" value="alice@acme.corp" readonly>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" value="password123" readonly>
      </div>
      <button class="modal-btn primary" onclick="completeLogin()">Sign In</button>
      <p class="modal-note">OAuth 2.0 flow — server issues a reusable bearer token with $10k approval limit</p>
    </div>
  </div>

  <!-- Wallet Approval Modal -->
  <div class="modal-overlay" id="walletModal">
    <div class="modal wallet-modal">
      <h2>Wallet Authorization Request</h2>
      <p style="color:var(--text-1); margin-bottom:1rem; font-size:0.9rem;">
        A service is requesting your credentials
      </p>
      <div class="wallet-details">
        <div class="wallet-detail">
          <span class="wallet-detail-label">Requesting Party</span>
          <span class="wallet-detail-value" id="walletDomain">—</span>
        </div>
        <div class="wallet-detail">
          <span class="wallet-detail-label">Credentials</span>
          <span class="wallet-detail-value" id="walletCreds">—</span>
        </div>
        <div class="wallet-detail">
          <span class="wallet-detail-label">Purpose</span>
          <span class="wallet-detail-value" id="walletPurpose">—</span>
        </div>
      </div>
      <button class="modal-btn success" onclick="approveWallet()">Approve</button>
      <p class="modal-note">Alice's wallet signs a Verifiable Presentation with her private key</p>
    </div>
  </div>

  <script>
    // ============================================================
    // State
    // ============================================================
    const state = {
      sessionId: null,
      mode: 'jwt-only',
      persona: 'alice',
      isStreaming: false,
      jwt: null,
    };

    // ============================================================
    // DOM
    // ============================================================
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);
    const chatMessages = $('#chatMessages');
    const chatInput = $('#chatInput');
    const sendBtn = $('#sendBtn');
    const suggestedPrompts = $('#suggestedPrompts');
    const jwtContent = $('#jwtContent');
    const vpContent = $('#vpContent');
    const vcContent = $('#vcContent');

    // ============================================================
    // Init
    // ============================================================
    function init() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('persona') === 'attacker') {
        state.persona = 'attacker';
        document.body.classList.add('attacker-mode');
      }

      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });

      createSession();
    }

    // ============================================================
    // Session Management
    // ============================================================
    async function createSession() {
      setInputEnabled(false);
      clearChat();
      clearArtifacts();
      setLoggedOut();
      addSystemMessage('Creating session...');

      try {
        const res = await fetch('/api/agent/session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: state.mode, persona: state.persona }),
        });
        const data = await res.json();
        state.sessionId = data.sessionId;

        if (state.persona === 'attacker') {
          addSystemMessage('Attacker session ready. Paste a stolen JWT to test it.');
          chatInput.placeholder = 'Paste a stolen JWT: eyJhbG... list expenses';
          setInputEnabled(true);
          updateSuggestedPrompts(['Paste a JWT to try using it']);
          return;
        }

        if (state.mode === 'jwt-only') {
          // No login upfront — JWT is acquired on first 401 (MCP auth pattern)
          addAssistantMessage(
            "Hello! I can help you manage expenses. I'll authenticate when we make our first API call. What would you like to do?"
          );
          setInputEnabled(true);
          updateSuggestedPrompts([
            'List pending expenses',
            'Approve the $5,000 marketing expense',
            'Approve the $15,000 executive retreat',
          ]);
        } else {
          addSystemMessage('VC-Protected session ready. Wallet loaded with credentials.');
          if (data.walletState) {
            updateVcArtifact({
              holder: data.walletState.holder,
              credentials: data.walletState.credentials,
              approvalLimit: data.approvalLimit || 10000,
            });
          }
          addAssistantMessage(
            "Hello! Each operation will go through a full **Verifiable Credential** authorization flow. What would you like to do?"
          );
          setInputEnabled(true);
          updateSuggestedPrompts([
            'List pending expenses',
            'Approve the $5,000 marketing expense',
            'Approve the $15,000 executive retreat',
          ]);
        }
      } catch (err) {
        addSystemMessage('Failed to create session: ' + err.message);
      }
    }

    async function resetDemo() {
      state.sessionId = null;
      state.jwt = null;
      await createSession();
    }

    function switchMode(mode) {
      if (mode === state.mode) return;
      state.mode = mode;
      $$('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
      resetDemo();
    }

    // ============================================================
    // Login Modal (JWT-only mode)
    // ============================================================
    function completeLogin() {
      hideModal('loginModal');
      setLoggedIn('Alice');
      if (state.sessionId) {
        fetch('/api/agent/chat/login-approved', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: state.sessionId }),
        }).catch(() => {});
      }
    }

    // ============================================================
    // Wallet Modal (VC-protected mode)
    // ============================================================
    function showWalletModal(data) {
      $('#walletDomain').textContent = data.requestingParty || '—';
      $('#walletCreds').textContent = (data.credentials || []).join(', ') || '—';
      $('#walletPurpose').textContent = data.purpose || '—';
      showModal('walletModal');
    }

    async function approveWallet() {
      hideModal('walletModal');
      setLoggedIn('Alice');
      if (state.sessionId) {
        fetch('/api/agent/chat/wallet-approved', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: state.sessionId }),
        }).catch(() => {});
      }
    }

    // ============================================================
    // Chat & SSE
    // ============================================================
    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text || !state.sessionId || state.isStreaming) return;

      chatInput.value = '';
      setInputEnabled(false);
      state.isStreaming = true;
      clearSuggestedPrompts();
      addUserMessage(text);

      try {
        const response = await fetch('/api/agent/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, sessionId: state.sessionId }),
        });
        await readSseStream(response);
      } catch (err) {
        addSystemMessage('Error: ' + err.message);
      }

      state.isStreaming = false;
      setInputEnabled(true);
      chatInput.focus();
    }

    async function readSseStream(response) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const parts = buffer.split('\n\n');
        buffer = parts.pop() || '';

        for (const part of parts) {
          if (!part.trim()) continue;
          const lines = part.split('\n');
          let evtType = '', evtData = '';
          for (const line of lines) {
            if (line.startsWith('event:')) evtType = line.slice(6).trim();
            else if (line.startsWith('data:')) evtData += line.slice(5).trim();
          }
          if (evtType && evtData) {
            try { handleSseEvent(evtType, JSON.parse(evtData)); }
            catch (e) { console.error('SSE parse error:', e, evtData); }
          }
        }
      }
    }

    function handleSseEvent(type, data) {
      switch (type) {
        case 'tool_call_start':
          renderToolCallStart(data.id, data.name, data.params);
          break;
        case 'tool_call_result':
          renderToolCallResult(data.id, data.result, data.status);
          break;
        case 'message':
          addAssistantMessage(data.content);
          break;
        case 'artifact_update':
          if (data.type === 'jwt') {
            const tokenMode = state.mode === 'jwt-only' ? 'reusable' : 'single-use';
            updateJwtArtifact(data.data, tokenMode);
          }
          else if (data.type === 'vp') updateVpArtifact(data.data);
          else if (data.type === 'vc') updateVcArtifact(data.data);
          break;
        case 'login_required':
          showModal('loginModal');
          break;
        case 'wallet_approval_required':
          showWalletModal(data);
          break;
        case 'done':
          if (data.suggestedPrompts) updateSuggestedPrompts(data.suggestedPrompts);
          break;
      }
    }

    // ============================================================
    // Rendering
    // ============================================================
    function addUserMessage(text) {
      const d = document.createElement('div');
      d.className = 'msg msg-user';
      d.textContent = text;
      chatMessages.appendChild(d);
      scrollChat();
    }

    function addAssistantMessage(text) {
      const d = document.createElement('div');
      d.className = 'msg msg-assistant';
      d.innerHTML = renderMarkdown(text);
      chatMessages.appendChild(d);
      scrollChat();
    }

    function addSystemMessage(text) {
      const d = document.createElement('div');
      d.className = 'msg msg-system';
      d.textContent = text;
      chatMessages.appendChild(d);
      scrollChat();
    }

    function renderToolCallStart(id, name, params) {
      const d = document.createElement('div');
      d.className = 'tool-call';
      d.id = 'tc-' + id;
      d.innerHTML =
        '<div class="tool-call-header" onclick="toggleToolCall(\'' + id + '\')">' +
          '<span class="tc-status pending" id="tcs-' + id + '">&#x25CF;</span>' +
          '<span class="tc-name">' + esc(name) + '</span>' +
          '<span class="tc-summary" id="tcsum-' + id + '"></span>' +
          '<span class="tc-chevron" id="tcc-' + id + '">&#x25B8;</span>' +
        '</div>' +
        '<div class="tc-body" id="tcb-' + id + '">' +
          '<div class="tc-label">Parameters</div>' +
          '<pre class="tc-json">' + esc(JSON.stringify(params, null, 2)) + '</pre>' +
          '<div id="tcr-' + id + '"></div>' +
        '</div>';
      chatMessages.appendChild(d);
      scrollChat();
    }

    function renderToolCallResult(id, result, status) {
      const s = document.getElementById('tcs-' + id);
      const r = document.getElementById('tcr-' + id);
      const sum = document.getElementById('tcsum-' + id);
      if (s) {
        s.className = 'tc-status ' + status;
        s.innerHTML = status === 'success' ? '&#x2713;' : '&#x2717;';
      }
      if (r) {
        r.innerHTML =
          '<div class="tc-label">Result</div>' +
          '<pre class="tc-json">' + esc(JSON.stringify(result, null, 2)) + '</pre>';
      }
      // Show a one-line summary so the user can see what happened without expanding
      if (sum) {
        if (status === 'error') {
          const msg = result.message || result.error || 'error';
          const code = result._statusCode ? (' ' + result._statusCode) : '';
          sum.textContent = code + ' — ' + msg;
        } else {
          // Brief summary: count keys or show a short descriptor
          const keys = Object.keys(result);
          sum.textContent = keys.length <= 3 ? keys.join(', ') : keys.length + ' fields';
        }
      }
      scrollChat();
    }

    function toggleToolCall(id) {
      const b = document.getElementById('tcb-' + id);
      const c = document.getElementById('tcc-' + id);
      if (b) b.classList.toggle('open');
      if (c) c.classList.toggle('open');
    }

    // ============================================================
    // Artifacts
    // ============================================================
    function updateJwtArtifact(token, tokenMode) {
      state.jwt = token;
      if (!token) { jwtContent.innerHTML = '<span class="artifact-empty">No token</span>'; return; }

      let html = '';
      if (tokenMode === 'reusable') {
        html += '<span class="mode-label reusable">Reusable Bearer Token</span>';
      } else if (tokenMode === 'single-use') {
        html += '<span class="mode-label single-use">Single-Use Token</span>';
      }
      html += '<div class="jwt-raw" title="Click to copy" onclick="copyJwt()">' + esc(token) + '</div>';

      try {
        const decoded = decodeJwt(token);
        html += '<pre class="jwt-decoded">' + esc(JSON.stringify(decoded.payload, null, 2)) + '</pre>';
      } catch (e) {}

      jwtContent.innerHTML = html;
    }

    function updateVpArtifact(vp) {
      if (!vp) { vpContent.innerHTML = '<span class="artifact-empty">No presentation</span>'; return; }
      vpContent.innerHTML = '<pre class="artifact-json">' + esc(JSON.stringify(vp, null, 2)) + '</pre>';
    }

    function updateVcArtifact(data) {
      if (!data) { vcContent.innerHTML = '<span class="artifact-empty">No credentials</span>'; return; }
      vcContent.innerHTML = '<pre class="artifact-json">' + esc(JSON.stringify(data, null, 2)) + '</pre>';
    }

    function clearArtifacts() {
      state.jwt = null;
      jwtContent.innerHTML = '<span class="artifact-empty">No token yet</span>';
      vpContent.innerHTML = '<span class="artifact-empty">No presentation yet</span>';
      vcContent.innerHTML = '<span class="artifact-empty">No credentials loaded</span>';
    }

    function copyJwt() {
      if (!state.jwt) return;
      navigator.clipboard.writeText(state.jwt);
      const btn = $('#jwtSection .copy-btn');
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
    }

    // ============================================================
    // Suggested Prompts
    // ============================================================
    function updateSuggestedPrompts(prompts) {
      suggestedPrompts.innerHTML = prompts.map(p =>
        '<button class="prompt-chip" onclick="useSuggestedPrompt(this)">' + esc(p) + '</button>'
      ).join('');
    }
    function clearSuggestedPrompts() { suggestedPrompts.innerHTML = ''; }
    function useSuggestedPrompt(el) { chatInput.value = el.textContent; sendMessage(); }

    // ============================================================
    // Modal helpers
    // ============================================================
    function showModal(id) { document.getElementById(id).classList.add('visible'); }
    function hideModal(id) { document.getElementById(id).classList.remove('visible'); }

    function toggleEndpoints(e) {
      e.stopPropagation();
      $('#endpointsDropdown').classList.toggle('open');
    }
    document.addEventListener('click', () => {
      $('#endpointsDropdown').classList.remove('open');
    });

    // ============================================================
    // Helpers
    // ============================================================
    function setLoggedIn(name) {
      const badge = $('#personaBadge');
      badge.textContent = name;
      badge.className = 'persona-badge alice';
    }
    function setLoggedOut() {
      const badge = $('#personaBadge');
      badge.textContent = 'Login';
      badge.className = 'persona-badge';
    }
    function setInputEnabled(on) {
      chatInput.disabled = !on;
      sendBtn.disabled = !on;
      if (on) chatInput.focus();
    }
    function clearChat() { chatMessages.innerHTML = ''; }
    function scrollChat() { chatMessages.scrollTop = chatMessages.scrollHeight; }

    function esc(str) {
      const d = document.createElement('div');
      d.textContent = String(str);
      return d.innerHTML;
    }

    function renderMarkdown(text) {
      return esc(text)
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/`(.+?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
    }

    function decodeJwt(token) {
      const parts = token.split('.');
      if (parts.length !== 3) throw new Error('Invalid JWT');
      function b64(s) {
        s = s.replace(/-/g, '+').replace(/_/g, '/');
        while (s.length % 4) s += '=';
        return JSON.parse(atob(s));
      }
      return { header: b64(parts[0]), payload: b64(parts[1]) };
    }

    // ============================================================
    // Start
    // ============================================================
    init();
  </script>
</body>
</html>
