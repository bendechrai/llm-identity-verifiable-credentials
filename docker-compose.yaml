services:
  # VC Issuer - Issues employment and finance approver credentials
  vc-issuer:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: vc-issuer
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
    volumes:
      - ./src/vc-issuer:/app/src/vc-issuer
      - ./src/lib:/app/src/lib
      - ./shared:/app/shared
      - issuer-keys:/app/keys
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # VC Wallet - Stores credentials, creates Verifiable Presentations
  vc-wallet:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: vc-wallet
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - PORT=3002
      - ISSUER_URL=http://vc-issuer:3001
    volumes:
      - ./src/vc-wallet:/app/src/vc-wallet
      - ./src/lib:/app/src/lib
      - ./shared:/app/shared
      - wallet-keys:/app/keys
    depends_on:
      vc-issuer:
        condition: service_healthy
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Auth Server - Verifies VPs, issues constrained JWTs (trust boundary)
  auth-server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: auth-server
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - PORT=3003
      - ISSUER_URL=http://vc-issuer:3001
      - TOKEN_EXPIRY_SECONDS=60
    volumes:
      - ./src/auth-server:/app/src/auth-server
      - ./src/lib:/app/src/lib
      - ./shared:/app/shared
      - auth-keys:/app/keys
    depends_on:
      vc-issuer:
        condition: service_healthy
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Expense API - Pure resource server (validates JWTs, enforces ceiling)
  expense-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: expense-api
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=development
      - PORT=3005
      - AUTH_SERVER_URL=http://auth-server:3003
    volumes:
      - ./src/expense-api:/app/src/expense-api
      - ./src/lib:/app/src/lib
      - ./shared:/app/shared
    depends_on:
      auth-server:
        condition: service_healthy
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3005/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # LLM Agent - Orchestrates the authorization flow (deterministic, no external LLM)
  llm-agent:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: llm-agent
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=development
      - PORT=3004
      - AUTH_SERVER_URL=http://auth-server:3003
      - EXPENSE_API_URL=http://expense-api:3005
      - WALLET_URL=http://vc-wallet:3002
    volumes:
      - ./src/llm-agent:/app/src/llm-agent
      - ./src/lib:/app/src/lib
      - ./shared:/app/shared
    depends_on:
      auth-server:
        condition: service_healthy
      expense-api:
        condition: service_healthy
      vc-wallet:
        condition: service_healthy
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Demo UI - Presentation interface (proxies API calls to backend services)
  demo-ui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: demo-ui
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - AGENT_HOST=llm-agent
      - AGENT_PORT=3004
      - AUTH_HOST=auth-server
      - AUTH_PORT=3003
      - EXPENSE_HOST=expense-api
      - EXPENSE_PORT=3005
    volumes:
      - ./src/demo-ui:/app/src/demo-ui
      - ./src/lib:/app/src/lib
      - ./shared:/app/shared
    depends_on:
      llm-agent:
        condition: service_healthy
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  demo-network:
    driver: bridge

volumes:
  issuer-keys:
  wallet-keys:
  auth-keys:
